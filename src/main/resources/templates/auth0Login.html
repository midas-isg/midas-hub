<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>Login - MIDAS</title>
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel='icon' th:href="@{/public/favicon.ico}"/>
    </head>
    <body>
        <script th:src="@{/webjars/auth0-lock/build/auth0-lock.min.js}"></script>
        <script src="https://cdn.auth0.com/w2/auth0-6.8.js"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            (function() {
                var auth0ClientId = /*[[${@environment.getProperty('auth0.clientId')}]]*/ '';
                var auth0Domain = /*[[${@environment.getProperty('auth0.domain')}]]*/ '';
                var state = /*[[${state}]]*/ '';
                var callbackUrl = /*[[${callbackUrl}]]*/ '';
                var icon = /*[[@{/public/logo.png}]]*/ '';

                var auth0 = new Auth0({
                    domain: auth0Domain,
                    clientID: auth0ClientId,
                    callbackURL: callbackUrl
                });
                auth0.getSSOData(function (err, data) {
                    var loggedInUserId = /*[[${userId}]]*/ '';
                    var homePath = /*[[@{/secured/home}]]*/ '';
                    var logoutPath = /*[[@{/logout}]]*/ '';
                    if (data && data.sso === true) {
                        // have SSO session
                        console.log('SSO: an Auth0 SSO session already exists');
                        if (loggedInUserId !== data.lastUsedUserID) {
                            // have SSO session but no valid local session - auto-login user
                            auth0.login({
                                scope: 'openid name email picture',
                                state: state,
                                callbackURL: callbackUrl
                            }, function (err) {
                                // this only gets called if there was a login error
                                console.error('Error logging in: ' + err);
                            });
                        } else {
                            // have SSO session and valid user - send to successfully authenticated landing page
                            window.location = homePath;
                        }
                    } else {
                        if (loggedInUserId) {
                            // have local session (autenticated locally), but no SSO session exists so log them out locally too - will force login page
                            window.location = logoutPath;
                        } else {
                            // have no SSO session and are not authenticated locally - present Lock widget Login box
                            new Auth0Lock(auth0ClientId, auth0Domain).show({
                                dict: {
                                    signin: {
                                        title: "MIDAS Hub"
                                    }
                                },
                                sso: true,

                                icon: icon,
                                callbackURL: callbackUrl,
                                responseType: 'code',
                                rememberLastLogin: false,
                                closable: false,
                                authParams: {
                                    state: state,
                                    scope: 'openid roles user_id name nickname email picture'
                                }
                            });
                        }
                    }
                });
            }());
            /*]]>*/
        </script>
    </body>
</html>
